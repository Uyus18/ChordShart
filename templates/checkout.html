<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChordCart - Checkout</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>ðŸŽ¸ CHORDCART - CHECKOUT ðŸŽ¸</header>

  <nav>
    <a href="{{ url_for('index') }}">Home</a>
    <a href="{{ url_for('shop') }}">Shop</a>
    <a href="{{ url_for('cart') }}">Cart</a>
  </nav>

  <section id="checkout">
    <h2>ðŸ§¾ Checkout</h2>
    <div id="checkout-items"></div>
    <div id="checkout-total"><strong>Total: â‚±0</strong></div>

    <form id="checkoutForm">
      <label>Full Name</label>
      <input type="text" id="fullname" required>

      <label>Address</label>
      <input type="text" id="address" required>

      <label>Payment Method</label>
      <select id="payment" required>
        <option value="" disabled selected>Select</option>
        <option value="delivery">Door-to-Door Delivery</option>
        <option value="gcash">GCash QR Code</option>
      </select>

      <div id="deliveryOptions" style="display:none;">
        <label>Delivery Location</label>
        <select id="location">
          <option value="Naga City">Naga City (+â‚±50)</option>
          <option value="Cebu City">Cebu City (+â‚±100)</option>
          <option value="Outside Cebu">Outside Cebu (+â‚±150)</option>
        </select>
      </div>

      <div id="gcashSection" style="display:none;">
        <p>ðŸ“± Scan to Pay with GCash:</p>
        <img src="{{ url_for('static', filename='gcash_qr.png') }}" alt="GCash QR" width="200">
      </div>

      <div id="finalDisplay">
        <strong>Total with Fees:</strong> â‚±<span id="finalTotal">0</span>
      </div>

      <button type="submit" class="button">Place Order</button>
    </form>
  </section>

  <footer>
    &copy; 2025 ChordChart Guitar Store. All Rights Reserved.
  </footer>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const checkoutItems = document.getElementById('checkout-items');
    const checkoutTotal = document.getElementById('checkout-total');
    const finalTotal = document.getElementById('finalTotal');
    const paymentSelect = document.getElementById('payment');
    const deliveryOptions = document.getElementById('deliveryOptions');
    const gcashSection = document.getElementById('gcashSection');
    const locationSelect = document.getElementById('location');

    let total = 0;
    let deliveryFee = 0;

    function renderCheckout() {
      checkoutItems.innerHTML = '';
      total = 0;

      if (cart.length === 0) {
        checkoutItems.innerHTML = '<p>Your cart is empty!</p>';
        checkoutTotal.innerHTML = '<strong>Total: â‚±0</strong>';
        finalTotal.textContent = '0';
        return;
      }

      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        checkoutItems.innerHTML += `<div>${item.name} x ${item.quantity} = â‚±${itemTotal}</div>`;
      });

      checkoutTotal.innerHTML = `<strong>Total: â‚±${total}</strong>`;
      updateFinalTotal();
    }

    function updateFinalTotal() {
      finalTotal.textContent = total + deliveryFee;
    }

    paymentSelect.addEventListener('change', () => {
      if (paymentSelect.value === 'delivery') {
        deliveryOptions.style.display = 'block';
        gcashSection.style.display = 'none';
        updateFinalTotal();
      } else {
        deliveryOptions.style.display = 'none';
        gcashSection.style.display = 'block';
        deliveryFee = 0;
        updateFinalTotal();
      }
    });

    locationSelect.addEventListener('change', () => {
      if (locationSelect.value === 'Naga City') deliveryFee = 50;
      else if (locationSelect.value === 'Cebu City') deliveryFee = 100;
      else deliveryFee = 150;
      updateFinalTotal();
    });

    document.getElementById('checkoutForm').addEventListener('submit', (e) => {
      e.preventDefault();
      alert(`Thank you! Your order (â‚±${total + deliveryFee}) has been placed.`);
      localStorage.removeItem('cart');
      window.location.href = '{{ url_for("shop") }}';

      document.getElementById("confirmOrderBtn").addEventListener("click", async () => {
  const items = JSON.parse(localStorage.getItem('cart')) || [];
  const total = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
  const payment_method = document.querySelector('input[name="payment"]:checked').value;
  const address = document.getElementById("address").value;
  const location = document.getElementById("location").value;

  const response = await fetch("/submit_cart", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items, total, payment_method, address, location })
  });

  const result = await response.json();
  if (result.success) {
    alert(`Order placed! Final Total: â‚±${result.final_total}`);
    localStorage.removeItem("cart");
    window.location.href = "/shop";
  }
});

    });

    renderCheckout();
  </script>
</body>
</html>
